<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript"
    src="http://maps.google.com/maps/api/js?sensor=true">
</script>
<script type="text/javascript">
  var map;
  var marker;
  var mapbounds;
  var mapmarkers=new Array();
  
  
  function initialize() {
   //bogus options. the function autoZoomCenter will fix this
    var myOptions = {
      zoom: 1,
      center: new google.maps.LatLng(15,-15),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
	
      map = new google.maps.Map(document.getElementById("map_canvas"),
        myOptions);
	  initializeGPSData();
	  autoZoomCenter();
	  infowindowStart = new google.maps.InfoWindow();   
	  infowindowEnd = new google.maps.InfoWindow();   
	  if(mapmarkers.length > 0){
		highlightMarker(mapmarkers[0]);
		var nameOfEvent= '<%= @contents['name'] %>';
		var startTime= mapmarkers[0].title;
		var endTime= mapmarkers[mapmarkers.length-1].title;
		infowindowStart.setPosition(mapmarkers[0].position);
		infowindowStart.setContent('Event: '+nameOfEvent+ '<\BR>Start Time: ' + startTime);
		infowindowStart.open(map);
		
		infowindowEnd.setPosition(mapmarkers[mapmarkers.length-1].position);
		infowindowEnd.setContent('Event: '+nameOfEvent+ '<\BR>End Time: ' + endTime);
		infowindowEnd.open(map);
	  }

	  
	  
		
	  
  }
  function initializeGPSData(){
   
	<% @gps_coords.each do |gps_coord| %>
		var latlng = new google.maps.LatLng(<%= gps_coord['latitude'] %>, <%= gps_coord['longitude'] %>);
		var timeOfGPSData=formatDateTime(<%= gps_coord['time'] %>);
		marker = new google.maps.Marker({
			position: latlng, 
			title: timeOfGPSData
		}); 
		mapmarkers.push(marker);
		marker.setMap(map);
		
	<% end %>
  }
  function autoZoomCenter(){
  mapbounds = new google.maps.LatLngBounds();
  for(var i=0; i<mapmarkers.length; i++){ 
     mapbounds.extend(mapmarkers[i].position ); 
  } 

	map.fitBounds(mapbounds);
  
  }
  function formatDateTime(time)
{
	var dateTime=new Date(time);
	var am_pm = '';
	var hour = dateTime.getHours();
	var min = dateTime.getMinutes();
	var month = dateTime.getMonth() + 1;
	var day = dateTime.getDate();
	day = (day < 10) ? '0' + day : day;
	month = (month < 10) ? '0' + month : month;
	am_pm = (hour < 12) ? "AM" : "PM";
	hour = (hour == 0) ? 12 : (hour > 12) ? hour - 12 : hour;
	hour = (hour < 10) ? '0' + hour : hour;
	min = (min < 10) ? '0' + min : min;
	return dateTime = month + '/' + day + '/' + dateTime.getFullYear() + ' ' + hour + ':' + min + ' ' + am_pm;
}
  function highlightMarker(marker){
  //marker.setIcon("http://maps.google.com/mapfiles/ms/icons/yellow-dot.png");
  }


</script>
</head>
<body onload="initialize()">
  <h3>Map for event: <%= @contents['name'] %></h3>
  <div id="map_canvas" style="width:50%; height:50%; border: 2px solid rgb(0, 0, 0)" ></div>
</body>
</html>